<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>The Guardian Guide (MVP)</title>
  <style>
    body { font-family: system-ui, sans-serif; margin:0; background:#f6f7f9; }
    #app { max-width: 720px; margin: 0 auto; padding: 16px 16px 120px; }
    .card { background:white; border-radius:12px; padding:16px; box-shadow:0 2px 12px rgba(0,0,0,0.06); }
    #log { height: 60vh; overflow:auto; padding: 8px; background:#fff; border-radius:8px; }
    .m { margin: 8px 0; }
    .me { text-align: right; }
    .bot { text-align: left; }
    .pill { display:inline-block; background:#eef2ff; color:#3743a5; padding:6px 10px; border-radius:999px; font-size:12px; margin-right:6px; cursor:pointer; }
    #consent { font-size: 12px; color:#555; margin-top: 8px; }
    #footer { position: fixed; bottom:0; left:0; right:0; background:white; border-top:1px solid #eee; padding:8px; }
    #input { width: calc(100% - 180px); padding:10px; border:1px solid #ddd; border-radius:10px; }
    button { padding:10px 14px; border:0; background:#3743a5; color:white; border-radius:10px; margin-left:8px; cursor:pointer; }
    #end { background:#f43f5e; }
  </style>
</head>
<body>
  <div id="app">
    <h1>The Guardian Guide</h1>
    <div class="card">
      <div id="log"></div>

      <div id="consent">
        <strong>Privacy:</strong> By continuing you agree to our privacy notice.
        We store as little as possible—please avoid sharing personal health details.
      </div>

      <div style="margin-top:8px;">
        <span class="pill" onclick="quick('Start a new embedded session')">Start a new session</span>
        <span class="pill" onclick="quick('Help me with a sensitive MHFA conversation')">Sensitive conversation</span>
        <span class="pill" onclick="quick('I need country-specific crisis contacts')">Crisis contacts</span>
      </div>
    </div>
  </div>

  <div id="footer">
    <form id="form">
      <input id="input" placeholder="Type your message…" autocomplete="off" />
      <button type="submit">Send</button>
      <button type="button" id="end">End session</button>
    </form>
  </div>

  <script>
    const log = document.getElementById('log');
    const form = document.getElementById('form');
    const input = document.getElementById('input');
    const endBtn = document.getElementById('end');
    let history = [];
    const ACCESS_CODE = ""; // optional: if you set ACCESS_CODE in Vercel env, put it here for demo

    function add(text, who) {
      const p = document.createElement('div');
      p.className = 'm ' + (who === 'me' ? 'me' : 'bot');
      p.textContent = text;
      log.appendChild(p);
      log.scrollTop = log.scrollHeight;
    }

    function quick(text){ input.value = text; form.dispatchEvent(new Event('submit')); }

    // Inactivity timers: 2 min prompt, 3 min close message
    let promptTimer = null;
    let closeTimer = null;
    function resetInactivity() {
      if (promptTimer) clearTimeout(promptTimer);
      if (closeTimer) clearTimeout(closeTimer);
      promptTimer = setTimeout(() => add("Are you still here? I'm happy to continue if you need me.", 'bot'), 2 * 60 * 1000);
      closeTimer = setTimeout(() => add("I'll close this session for now, but you can return at any time.", 'bot'), 3 * 60 * 1000);
    }
    ['click','keypress','keydown','mousemove','touchstart'].forEach(evt =>
      window.addEventListener(evt, resetInactivity)
    );
    resetInactivity();

    async function sendMessage(content) {
      history.push({ role: 'user', content });
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ messages: history, access_code: ACCESS_CODE })
      });
      const data = await res.json();
      const reply = data.reply || 'Sorry, something went wrong.';
      history.push({ role: 'assistant', content: reply });
      return reply;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = input.value.trim();
      if (!content) return;
      add(content, 'me');
      input.value = '';
      resetInactivity();
      try {
        const reply = await sendMessage(content);
        add(reply, 'bot');
      } catch {
        add('Network error. Please try again.', 'bot');
      }
    });

    endBtn.addEventListener('click', () => {
      history = [];
      add('Session ended. Start a new embedded session anytime.', 'bot');
    });
  </script>
</body>
</html>
